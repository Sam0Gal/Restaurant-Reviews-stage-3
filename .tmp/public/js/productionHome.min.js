navigator.serviceWorker&&window.addEventListener("load",function(){navigator.serviceWorker.register("/sw.js").then(function(e){console.log("service worker registeration successful!")},function(e){console.log("service worker registeration failed.")})});let restaurants,neighborhoods,cuisines,dbPromise=idb.open("restaurants reviews",1,function(e){e.createObjectStore("restaurants",{keyPath:"id"})}),isCached=!1;class DBHelper{static get DATABASE_URL(){return"http://localhost:1337/restaurants"}static fetchRestaurants(e){let t=!1;dbPromise.then(function(e){return e.transaction("restaurants").objectStore("restaurants").getAll()}).then(function(a){if(0!==Object.keys(a).length&&(e(null,a),t=!0,console.log("data fetched from idb")),t)return;let n=new XMLHttpRequest;n.open("GET",DBHelper.DATABASE_URL),n.onload=(()=>{if(200===n.status){const t=JSON.parse(n.responseText);dbPromise.then(function(e){const a=e.transaction("restaurants","readwrite").objectStore("restaurants");t.forEach(e=>{a.put(e)})}).then(function(){console.log("data chached.")}),e(null,t)}else{const t=`Request failed. Returned status of ${n.status}`;e(t,null)}}),n.send()})}static fetchRestaurantById(e,t){DBHelper.fetchRestaurants((a,n)=>{if(a)t(a,null);else{const a=n.find(t=>t.id==e);a?t(null,a):t("Restaurant does not exist",null)}})}static fetchRestaurantByCuisine(e,t){DBHelper.fetchRestaurants((a,n)=>{if(a)t(a,null);else{const a=n.filter(t=>t.cuisine_type==e);t(null,a)}})}static fetchRestaurantByNeighborhood(e,t){DBHelper.fetchRestaurants((a,n)=>{if(a)t(a,null);else{const a=n.filter(t=>t.neighborhood==e);t(null,a)}})}static fetchRestaurantByCuisineAndNeighborhood(e,t,a){DBHelper.fetchRestaurants((n,s)=>{if(n)a(n,null);else{let n=s;"all"!=e&&(n=n.filter(t=>t.cuisine_type==e)),"all"!=t&&(n=n.filter(e=>e.neighborhood==t)),a(null,n)}})}static fetchNeighborhoods(e){DBHelper.fetchRestaurants((t,a)=>{if(t)e(t,null);else{const t=a.map((e,t)=>a[t].neighborhood),n=t.filter((e,a)=>t.indexOf(e)==a);e(null,n)}})}static fetchCuisines(e){DBHelper.fetchRestaurants((t,a)=>{if(t)e(t,null);else{const t=a.map((e,t)=>a[t].cuisine_type),n=t.filter((e,a)=>t.indexOf(e)==a);e(null,n)}})}static urlForRestaurant(e){return`restaurant.html?id=${e.id}`}static imageUrlForRestaurant(e){return`/img/${e.photograph}`}static mapMarkerForRestaurant(e,t){const a=new L.marker([e.latlng.lat,e.latlng.lng],{title:e.name,alt:e.name,url:DBHelper.urlForRestaurant(e)});return a.addTo(newMap),a}static updateFavorites(e){dbPromise.then(function(t){return t.transaction("restaurants","readwrite").objectStore("restaurants").openCursor(e)}).then(function(e){if(!e)return;const t=e.value.is_favorite;let a=e.value;t?(a.is_favorite=!1,e.update(a)):(a.is_favorite=!0,e.update(a))})}}var newMap,markers=[];function toggleFavorite(e,t){e.classList.contains("added-to-favorite")?(e.classList.remove("added-to-favorite"),e.style.color="rgb(90, 88, 88)"):(e.classList.add("added-to-favorite"),e.style.color="yellow"),DBHelper.updateFavorites(t)}function skipMap(e){9===e.keyCode&&(e.shiftKey?document.querySelector("#footer a").focus():document.querySelector("select").focus()),e.preventDefault()}function skipMap2(e){9===e.keyCode&&e.shiftKey&&(document.querySelector("a").focus(),e.preventDefault())}document.addEventListener("DOMContentLoaded",e=>{initMap(),fetchNeighborhoods(),fetchCuisines()}),fetchNeighborhoods=(()=>{DBHelper.fetchNeighborhoods((e,t)=>{e?console.error(e):(self.neighborhoods=t,fillNeighborhoodsHTML())})}),fillNeighborhoodsHTML=((e=self.neighborhoods)=>{const t=document.getElementById("neighborhoods-select");e.forEach(e=>{const a=document.createElement("option");a.innerHTML=e,a.value=e,t.append(a)})}),fetchCuisines=(()=>{DBHelper.fetchCuisines((e,t)=>{e?console.error(e):(self.cuisines=t,fillCuisinesHTML())})}),fillCuisinesHTML=((e=self.cuisines)=>{const t=document.getElementById("cuisines-select");e.forEach(e=>{const a=document.createElement("option");a.innerHTML=e,a.value=e,t.append(a)})}),initMap=(()=>{self.newMap=L.map("map",{center:[40.722216,-73.987501],zoom:12,scrollWheelZoom:!1}),L.tileLayer("https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.jpg70?access_token={mapboxToken}",{mapboxToken:"pk.eyJ1IjoiZWxxbm55IiwiYSI6ImNqamQxNHFwdTAyMXYzcHBhaHpwaGVwYTEifQ.FKXd-SMgNLFqFxyPmSB6yQ",maxZoom:18,attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',id:"mapbox.streets"}).addTo(newMap),newMap.dragging.disable(),updateRestaurants()}),updateRestaurants=(()=>{const e=document.getElementById("cuisines-select"),t=document.getElementById("neighborhoods-select"),a=e.selectedIndex,n=t.selectedIndex,s=e[a].value,r=t[n].value;DBHelper.fetchRestaurantByCuisineAndNeighborhood(s,r,(e,t)=>{e?console.error(e):(resetRestaurants(t),fillRestaurantsHTML())})}),resetRestaurants=(e=>{self.restaurants=[],document.getElementById("restaurants-list").innerHTML="",self.markers&&self.markers.forEach(e=>e.remove()),self.markers=[],self.restaurants=e}),fillRestaurantsHTML=((e=self.restaurants)=>{const t=document.getElementById("restaurants-list");e.forEach(e=>{t.append(createRestaurantHTML(e))}),new LazyLoad,addMarkersToMap()}),createRestaurantHTML=(e=>{const t=document.createElement("li");let a=DBHelper.imageUrlForRestaurant(e);if("/img/undefined"===a){const e=document.createElement("div");e.className="restaurant-img";const a=document.createElement("p");a.append("Image's not available."),e.append(a),t.append(e)}else{const n=document.createElement("picture");t.append(n);const s=document.createElement("source");s.media="(min-width: 600px) and (max-width: 700px)",s.dataset.srcset=`${a}_small2x.jpg`;const r=document.createElement("source");r.dataset.srcset=`${a}_small.jpg, ${a}_small2x.jpg 2x, ${a}_small2x.jpg 3x`;const o=document.createElement("source");o.media="(min-width: 600px) and (max-width: 700px)",o.dataset.srcset=`${a}_small2x.webp`;const i=document.createElement("source");i.dataset.srcset=`${a}_small.webp, ${a}_small2x.webp 2x, ${a}_small2x.webp 3x`,n.append(o),n.append(i),n.append(s),n.append(r);const l=document.createElement("img");l.className="restaurant-img",l.dataset.src=a+"_small.jpg",l.alt=`${e.name} restaurant image`,n.append(l)}const n=document.createElement("h3");n.innerHTML=e.name,n.setAttribute("tabindex","0"),t.append(n);const s=document.createElement("p");s.innerHTML=e.neighborhood,t.append(s);const r=document.createElement("p");r.innerHTML=e.address,t.append(r);const o=document.createElement("a");o.innerHTML="View Details",o.href=DBHelper.urlForRestaurant(e),t.append(o);const i=document.createElement("span");return i.innerHTML="ðŸŸŠ",i.setAttribute("tabindex","0"),i.setAttribute("role","button"),i.classList.add("favorite"),e.is_favorite&&(i.classList.add("added-to-favorite"),i.style.color="yellow"),i.addEventListener("click",function(t){toggleFavorite(i,e.id)}),i.addEventListener("keyup",function(t){13==t.keyCode&&toggleFavorite(i,e.id)}),t.append(i),t}),addMarkersToMap=((e=self.restaurants)=>{e.forEach(e=>{const t=DBHelper.mapMarkerForRestaurant(e,self.newMap);t.on("click",function(){window.location.href=t.options.url}),self.markers.push(t)})}),document.querySelector("a").addEventListener("keydown",skipMap),document.querySelector("select").addEventListener("keydown",skipMap2);